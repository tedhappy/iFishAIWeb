# MCPå·¥å…·å•ä¾‹æ¨¡å¼å®ç°

## æ¦‚è¿°

æœ¬é¡¹ç›®ä¸ºqwen-agentå®ç°äº†ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„MCPï¼ˆModel Context Protocolï¼‰å·¥å…·å•ä¾‹æ¨¡å¼ï¼Œé€šè¿‡é™æ€å˜é‡ã€å…¨å±€é”å’ŒåŸå­æ“ä½œç¡®ä¿MCPå·¥å…·å®ä¾‹çš„å”¯ä¸€æ€§ï¼Œé¿å…é‡å¤æ³¨å†Œå’Œèµ„æºæµªè´¹ã€‚

## æ ¸å¿ƒç‰¹æ€§

### ğŸ”’ çº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼
- ä½¿ç”¨å…¨å±€é”ï¼ˆ`threading.RLock()`ï¼‰ç¡®ä¿çº¿ç¨‹å®‰å…¨
- æ”¯æŒå¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„å¹¶å‘è®¿é—®
- åŸå­æ“ä½œä¿è¯å®ä¾‹åˆ›å»ºçš„ä¸€è‡´æ€§

### ğŸ­ å·¥å‚æ¨¡å¼è®¾è®¡
- `MCPToolFactory`ç±»æä¾›ç»Ÿä¸€çš„å®ä¾‹åˆ›å»ºæ¥å£
- æ”¯æŒä¾èµ–æ³¨å…¥ï¼Œå¯ä¼ å…¥è‡ªå®šä¹‰é…ç½®
- è‡ªåŠ¨ç®¡ç†ä¸åŒé…ç½®çš„å®ä¾‹

### ğŸ”‘ é…ç½®å“ˆå¸Œæœºåˆ¶
- åŸºäºé…ç½®å†…å®¹ç”ŸæˆMD5å“ˆå¸Œå€¼
- ç›¸åŒé…ç½®è‡ªåŠ¨å¤ç”¨å·²æœ‰å®ä¾‹
- æ”¯æŒé…ç½®å†…å®¹çš„é¡ºåºæ— å…³æ€§

### ğŸ’¾ æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿ
- ç¼“å­˜å·²åˆå§‹åŒ–çš„å·¥å…·åˆ—è¡¨
- é¿å…é‡å¤åˆå§‹åŒ–ç›¸åŒé…ç½®
- æé«˜æ€§èƒ½å’Œå“åº”é€Ÿåº¦

### ğŸ§ª æµ‹è¯•å‹å¥½
- æä¾›`reset_all_instances()`æ–¹æ³•æ¸…ç†æµ‹è¯•ç¯å¢ƒ
- æ”¯æŒéš”ç¦»çš„æµ‹è¯•ç”¨ä¾‹
- å®Œæ•´çš„å•å…ƒæµ‹è¯•è¦†ç›–

## æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MCPToolFactory                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  create_manager(config=None)                        â”‚    â”‚
â”‚  â”‚  â”œâ”€ config is None â†’ get_default_instance()         â”‚    â”‚
â”‚  â”‚  â””â”€ config provided â†’ get_instance(hash, config)    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     MCPManager                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Class Variables:                                   â”‚    â”‚
â”‚  â”‚  â”œâ”€ _instances: Dict[str, MCPManager]               â”‚    â”‚
â”‚  â”‚  â”œâ”€ _default_instance: Optional[MCPManager]         â”‚    â”‚
â”‚  â”‚  â””â”€ _initialized_configs: Dict[str, List]           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Methods:                                           â”‚    â”‚
â”‚  â”‚  â”œâ”€ get_default_instance() â†’ MCPManager             â”‚    â”‚
â”‚  â”‚  â”œâ”€ get_instance(hash, config) â†’ MCPManager         â”‚    â”‚
â”‚  â”‚  â”œâ”€ initConfig(config) â†’ List[Tools]                â”‚    â”‚
â”‚  â”‚  â””â”€ reset_all_instances() â†’ None                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Global Lock                               â”‚
â”‚              _global_lock = threading.RLock()              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ä½¿ç”¨æ–¹æ³•

### 1. åŸºæœ¬ä½¿ç”¨

```python
from qwen_agent.tools.mcp_manager import MCPManager, MCPToolFactory

# æ–¹æ³•1: è·å–é»˜è®¤å•ä¾‹å®ä¾‹
manager = MCPManager.get_default_instance()

# æ–¹æ³•2: é€šè¿‡å·¥å‚è·å–é»˜è®¤å®ä¾‹
manager = MCPToolFactory.create_manager()

# æ–¹æ³•3: ä½¿ç”¨è‡ªå®šä¹‰é…ç½®
config = {
    "mcpServers": {
        "memory": {
            "command": "npx",
            "args": ["-y", "@modelcontextprotocol/server-memory"]
        }
    }
}
manager = MCPToolFactory.create_manager(config)
```

### 2. åœ¨Agentä¸­ä½¿ç”¨

```python
from flask_backend.agents.base_agent import BaseAgent

class CustomAgent(BaseAgent):
    def get_mcp_config(self):
        """é‡å†™æ­¤æ–¹æ³•æä¾›è‡ªå®šä¹‰MCPé…ç½®"""
        return {
            "mcpServers": {
                "filesystem": {
                    "command": "npx",
                    "args": ["-y", "@modelcontextprotocol/server-filesystem", "/path"]
                }
            }
        }
    
    def get_system_prompt(self):
        return "ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹"
    
    def get_function_list(self):
        return []  # ä½¿ç”¨MCPå·¥å…·

# åˆ›å»ºAgentå®ä¾‹
agent = CustomAgent("agent1", "user1")
```

### 3. ç›´æ¥åˆå§‹åŒ–MCPå·¥å…·

```python
# é…ç½®MCPæœåŠ¡å™¨
config = {
    "mcpServers": {
        "memory": {
            "command": "npx",
            "args": ["-y", "@modelcontextprotocol/server-memory"]
        },
        "filesystem": {
            "command": "npx",
            "args": ["-y", "@modelcontextprotocol/server-filesystem", "/tmp"]
        }
    }
}

# è·å–ç®¡ç†å™¨å¹¶åˆå§‹åŒ–
manager = MCPToolFactory.create_manager(config)
tools = manager.initConfig(config)

print(f"åˆå§‹åŒ–äº† {len(tools)} ä¸ªMCPå·¥å…·")
for tool in tools:
    print(f"- {tool.name}: {tool.description}")
```

## æ ¸å¿ƒç»„ä»¶

### MCPToolFactory
å·¥å‚ç±»ï¼Œæä¾›ç»Ÿä¸€çš„MCPç®¡ç†å™¨åˆ›å»ºæ¥å£ï¼š
- `create_manager(config=None)`: åˆ›å»ºæˆ–è·å–MCPç®¡ç†å™¨å®ä¾‹

### MCPManager
å•ä¾‹ç®¡ç†å™¨ç±»ï¼Œè´Ÿè´£MCPå·¥å…·çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼š
- `get_default_instance()`: è·å–é»˜è®¤å•ä¾‹å®ä¾‹
- `get_instance(config_hash, config)`: è·å–æŒ‡å®šé…ç½®çš„å®ä¾‹
- `initConfig(config)`: åˆå§‹åŒ–MCPé…ç½®å¹¶è¿”å›å·¥å…·åˆ—è¡¨
- `reset_all_instances()`: é‡ç½®æ‰€æœ‰å®ä¾‹ï¼ˆæµ‹è¯•ç”¨ï¼‰

### çº¿ç¨‹å®‰å…¨æœºåˆ¶
- å…¨å±€é”ï¼š`_global_lock = threading.RLock()`
- åŸå­æ“ä½œï¼šæ‰€æœ‰å®ä¾‹åˆ›å»ºå’Œè®¿é—®éƒ½åœ¨é”ä¿æŠ¤ä¸‹è¿›è¡Œ
- çº¿ç¨‹å®‰å…¨çš„ç±»å˜é‡ç®¡ç†

## é…ç½®æ ¼å¼

MCPé…ç½®éµå¾ªæ ‡å‡†æ ¼å¼ï¼š

```json
{
  "mcpServers": {
    "server_name": {
      "command": "npx",
      "args": ["-y", "package_name"],
      "env": {"ENV_VAR": "value"}  // å¯é€‰
    },
    "http_server": {
      "url": "http://localhost:8080/mcp",
      "headers": {"Authorization": "Bearer token"}  // å¯é€‰
    }
  }
}
```

## æµ‹è¯•

è¿è¡Œå•ä¾‹æ¨¡å¼æµ‹è¯•ï¼š

```bash
python test_mcp_singleton.py
```

æµ‹è¯•è¦†ç›–ï¼š
- âœ… åŸºæœ¬å•ä¾‹æ¨¡å¼
- âœ… é…ç½®åŸºç¡€çš„å®ä¾‹ç®¡ç†
- âœ… çº¿ç¨‹å®‰å…¨æ€§
- âœ… å·¥å‚æ¨¡å¼
- âœ… é…ç½®å“ˆå¸Œæœºåˆ¶
- âœ… é‡ç½®åŠŸèƒ½

è¿è¡Œä½¿ç”¨ç¤ºä¾‹ï¼š

```bash
python example_mcp_usage.py
```

## æœ€ä½³å®è·µ

### 1. é…ç½®ç®¡ç†
```python
# ä½¿ç”¨ç¯å¢ƒå˜é‡
config = {
    "mcpServers": {
        "memory": {
            "command": os.getenv("MCP_MEMORY_COMMAND", "npx"),
            "args": ["-y", os.getenv("MCP_MEMORY_PACKAGE", "@modelcontextprotocol/server-memory")]
        }
    }
}
```

### 2. é”™è¯¯å¤„ç†
```python
def safe_create_manager(config):
    try:
        return MCPToolFactory.create_manager(config)
    except Exception as e:
        logger.error(f"åˆ›å»ºMCPç®¡ç†å™¨å¤±è´¥: {e}")
        # é™çº§åˆ°é»˜è®¤ç®¡ç†å™¨
        return MCPManager.get_default_instance()
```

### 3. æµ‹è¯•éš”ç¦»
```python
def test_something():
    # æµ‹è¯•å‰æ¸…ç†
    MCPManager.reset_all_instances()
    
    # æ‰§è¡Œæµ‹è¯•
    manager = MCPToolFactory.create_manager(test_config)
    # ... æµ‹è¯•é€»è¾‘
    
    # æµ‹è¯•åæ¸…ç†
    MCPManager.reset_all_instances()
```

## æ€§èƒ½ä¼˜åŠ¿

1. **é¿å…é‡å¤è¿æ¥**: ç›¸åŒé…ç½®çš„MCPæœåŠ¡å™¨åªè¿æ¥ä¸€æ¬¡
2. **å†…å­˜ä¼˜åŒ–**: å•ä¾‹æ¨¡å¼å‡å°‘å†…å­˜å ç”¨
3. **ç¼“å­˜æœºåˆ¶**: å·²åˆå§‹åŒ–çš„å·¥å…·åˆ—è¡¨è¢«ç¼“å­˜ï¼Œé¿å…é‡å¤åˆå§‹åŒ–
4. **çº¿ç¨‹å®‰å…¨**: å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„é«˜æ•ˆå¹¶å‘è®¿é—®

## å…¼å®¹æ€§

- âœ… ä¸ç°æœ‰qwen-agentä»£ç å®Œå…¨å…¼å®¹
- âœ… æ”¯æŒæ‰€æœ‰ç°æœ‰çš„MCPé…ç½®æ ¼å¼
- âœ… å‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½
- âœ… æ”¯æŒPython 3.7+

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **MCPæœåŠ¡å™¨è¿æ¥å¤±è´¥**
   - æ£€æŸ¥MCPæœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ
   - éªŒè¯é…ç½®ä¸­çš„å‘½ä»¤å’Œå‚æ•°æ˜¯å¦æ­£ç¡®
   - æŸ¥çœ‹æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯

2. **å·¥å…·é‡å¤æ³¨å†Œè­¦å‘Š**
   - è¿™æ˜¯æ­£å¸¸è¡Œä¸ºï¼Œå•ä¾‹æ¨¡å¼ä¼šè‡ªåŠ¨å¤„ç†
   - åæ³¨å†Œçš„å·¥å…·ä¼šè¦†ç›–å…ˆæ³¨å†Œçš„åŒåå·¥å…·

3. **çº¿ç¨‹å®‰å…¨é—®é¢˜**
   - ç¡®ä¿ä½¿ç”¨æä¾›çš„å·¥å‚æ–¹æ³•åˆ›å»ºå®ä¾‹
   - ä¸è¦ç›´æ¥è°ƒç”¨MCPManageræ„é€ å‡½æ•°

### è°ƒè¯•æŠ€å·§

```python
# æŸ¥çœ‹å½“å‰å®ä¾‹çŠ¶æ€
print(f"é»˜è®¤å®ä¾‹: {id(MCPManager.get_default_instance())}")
print(f"å®ä¾‹æ•°é‡: {len(MCPManager._instances)}")
print(f"å·²åˆå§‹åŒ–é…ç½®: {list(MCPManager._initialized_configs.keys())}")

# é‡ç½®ç¯å¢ƒè¿›è¡Œè°ƒè¯•
MCPManager.reset_all_instances()
```

## æ›´æ–°æ—¥å¿—

### v1.0.0 (2025-01-15)
- âœ¨ å®ç°çº¿ç¨‹å®‰å…¨çš„å•ä¾‹æ¨¡å¼
- âœ¨ æ·»åŠ MCPToolFactoryå·¥å‚ç±»
- âœ¨ å®ç°é…ç½®å“ˆå¸Œæœºåˆ¶
- âœ¨ æ·»åŠ æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿ
- âœ¨ å®Œæ•´çš„æµ‹è¯•è¦†ç›–
- ğŸ“š è¯¦ç»†çš„æ–‡æ¡£å’Œç¤ºä¾‹

## è´¡çŒ®

æ¬¢è¿æäº¤Issueå’ŒPull Requestæ¥æ”¹è¿›è¿™ä¸ªå®ç°ã€‚è¯·ç¡®ä¿ï¼š
1. æ·»åŠ é€‚å½“çš„æµ‹è¯•
2. æ›´æ–°æ–‡æ¡£
3. éµå¾ªç°æœ‰çš„ä»£ç é£æ ¼

## è®¸å¯è¯

æœ¬é¡¹ç›®éµå¾ªä¸qwen-agentç›¸åŒçš„è®¸å¯è¯ã€‚