# Qwen-Agent 源码修改文档

## 修改原因

**核心技术问题**: Agent在思考过程中不能异步调用MCP工具，只能在思考结束后再调用，这是导致用户体验卡顿的根本原因。

**具体表现**:
1. **同步阻塞机制** - Agent必须完成全部思考后才能开始工具调用
2. **缺乏异步支持** - 工具调用过程无法与思考过程并行进行
3. **状态反馈缺失** - 用户无法感知工具调用的进度和状态

**为什么要修改源码**:
1. **原生qwen-agent架构限制** - 思考和工具调用是串行的，无法实现真正的异步
2. **实时状态反馈机制缺失** - 工具调用过程对用户完全不可见
3. **多会话状态污染问题** - 全局状态导致多用户并发时状态显示混乱
4. **用户体验差** - 长时间无响应让用户误以为系统卡死

**修改目标**: 在保持原有思考-工具调用流程的前提下，增加工具调用的实时状态反馈机制，让用户能够感知到系统正在工作。

## 源码修改详情

### 1. 后端路由层 - agent_routes.py

**修改位置**: `flask_backend/routes/agent_routes.py`

**修改内容**: 在chat_stream函数中增加工具状态回调机制

**达到效果**: 建立前后端工具状态通信桥梁，支持SSE实时推送

### 2. 基础Agent类 - base_agent.py

**修改位置**: `flask_backend/agents/base_agent.py`

**修改内容**: 
- 在chat_stream方法中增加tool_status_callback参数
- 为每个工具调用创建独立的状态回调包装器
- 添加状态恢复机制防止全局污染

**达到效果**: 解决多会话状态污染问题，确保每个用户会话的工具状态独立显示

### 3. MCP工具管理器 - mcp_manager.py

**修改位置**: `qwen_agent/tools/mcp_manager.py`

**修改内容**: 在create_tool_class方法中为MCP工具调用添加状态回调支持

**达到效果**: MCP工具调用过程中能够发送实时状态更新

### 4. 函数调用Agent - fncall_agent.py

**修改位置**: `qwen_agent/agents/fncall_agent.py`

**修改内容**: 在_try_call_mcp_tools_immediately方法中添加工具状态回调逻辑

**达到效果**: 函数调用Agent能够在工具执行前后发送状态更新

### 5. 前端状态显示 - loading-status.tsx & chat.ts

**修改位置**: 
- `app/components/loading-status.tsx`
- `app/store/chat.ts`

**修改内容**: 优化工具调用状态的显示文案，统一用户界面提示

**达到效果**: 提供更友好的用户提示，改善等待体验

## 修改效果总结

### 解决的核心问题
1. **消除界面卡顿** - 用户不再感受到工具调用时的"假死"状态
2. **实时进度反馈** - 用户能够看到"正在调用工具，请耐心等候"等状态提示
3. **多用户隔离** - 解决了多会话并发时状态显示混乱的问题
4. **保持兼容性** - 所有修改都是增量式的，不影响原有功能

### 技术实现要点
- **最小侵入性修改**: 通过回调机制扩展原有功能，而非重写核心逻辑
- **状态隔离机制**: 每个Agent实例独立管理工具状态，避免全局污染
- **实时通信**: 基于SSE实现前后端工具状态的实时同步

### 最终效果
用户在使用需要调用MCP工具的功能时，能够获得流畅的交互体验，清楚了解系统工作状态，显著提升了产品的可用性。